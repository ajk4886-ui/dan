<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Sticker Editor</title>

<style>
    body {
        margin: 0;
        display: flex;
        font-family: Arial;
        user-select: none;
    }

    /* 왼쪽 영역 */
    #left-panel {
        width: 250px;
        border-right: 2px solid #ccc;
        padding: 15px;
    }

    #openPopup {
        font-size: 30px;
        cursor: pointer;
        font-weight: 500;
        display: inline-block;
        
    }

    /* 팝업창 */
    #popup {
        position: fixed;
        top: 50px;
        left: 50px;
        width: 220px;
        padding: 15px;
        background: #fff;
        border: 2px solid #000;
        display: none;
        z-index: 1000;
    }

    #popup img {
        width: 90px;
        margin: 5px;
        cursor: pointer;
    }

    /* 클릭한 이미지 아래 뜨는 세부 팝업 */
    #selected-window {
        position: fixed;
        width: 180px;
        padding: 12px;
        background: #fff;
        border: 2px solid #000;
        display: none;
        z-index: 2000;
    }

    #selected-window img {
        width: 100%;
        display: block;
        margin-bottom: 10px;
    }

    #applyStickerBtn {
        width: 100%;
        padding: 8px;
        border: 2px solid #000;
        cursor: pointer;
        text-align: center;
        background: #eee;
    }

    /* 오른쪽 작업 영역 */
    #right-panel {
        flex: 1;
        padding: 20px;
    }

    #upload-box {
        
        width: 100%;
        height: 550px;
        background: #f5f5f5;
        border: 3px dashed #aaa;
        position: relative;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 22px;
        color: #777;
    }

    #bg-image {
        max-width: 100%;
        max-height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        pointer-events: none;
        object-fit: contain;
    }

    /* 스티커 */
    .sticker-wrapper {
        position: absolute;
        width: 120px;
        height: auto;
    }

    .placed-sticker {
        width: 100%;
        height: auto;
        cursor: move;
        display: block;
        pointer-events: none;
    }

    /* 크기 조절 */
    .resize-handle {
        width: 18px;
        height: 18px;
        background: #fff;
        border: 2px solid #000;
        position: absolute;
        right: -10px;
        bottom: -10px;
        cursor: se-resize;
        z-index: 999;
    }

    #saveBtn {
        margin-top: 20px;
        padding: 12px 25px;
        font-size: 18px;
        cursor: pointer;
    }

    #uploadBtn {
        margin-top: 15px;
        padding: 10px 15px;
        font-size: 16px;
        border: 2px solid #000;
        cursor: pointer;
    }
</style>
</head>

<body>

<!-- 왼쪽 패널 -->
<div id="left-panel">
    <div id="openPopup">S3l3ct sourc3 imag3</div>

    <!-- 팝업창 -->
    <div id="popup">
        <img src="img_1.png">
        <img src="img_2.png">
        <img src="img_3.png">
        <img src="img_4.png">
        <img src="img_5.png">
    </div>
</div>

<!-- 클릭한 이미지 아래 뜨는 팝업 -->
<div id="selected-window">
    <img id="selected-preview">
    <div id="applyStickerBtn">Us3 this Stick3r</div>
</div>

<!-- 오른쪽 작업 패널 -->
<div id="right-panel">
    <h2>Drag imag3 h3r3</h2>

    <button id="uploadBtn">Upload Imag3</button>
    <input type="file" id="bg-upload" accept="image/*" style="display:none;">

    <div id="upload-box">
        Drag & Drop imag3 h3r3
        <img id="bg-image">
    </div>

    <button id="saveBtn">sav3</button>
</div>

<script>
/* ------------------------------
   드래그/업로드 기능
------------------------------ */
const uploadBox = document.getElementById("upload-box");
const bgUpload = document.getElementById("bg-upload");
const bgImage = document.getElementById("bg-image");

uploadBox.addEventListener("dragover", e => e.preventDefault());

uploadBox.addEventListener("drop", e => {
    e.preventDefault();
    loadBackground(e.dataTransfer.files[0]);
});

document.getElementById("uploadBtn").addEventListener("click", () => {
    bgUpload.click();
});

bgUpload.addEventListener("change", e => {
    loadBackground(e.target.files[0]);
});

function loadBackground(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => bgImage.src = ev.target.result;
    reader.readAsDataURL(file);
}

/* ------------------------------
   팝업 토글
------------------------------ */
document.getElementById("openPopup").addEventListener("click", () => {
    const popup = document.getElementById("popup");
    popup.style.display = popup.style.display === "block" ? "none" : "block";
});

/* ------------------------------
   팝업 이미지 클릭 → 클릭한 이미지 아래에 미니창 표시
------------------------------ */
document.querySelectorAll("#popup img").forEach(img => {
    img.addEventListener("click", e => {
        const src = e.target.src;

        const rect = e.target.getBoundingClientRect();
        const win = document.getElementById("selected-window");

        win.style.display = "block";
        win.style.left = rect.left + "px";
        win.style.top = (rect.bottom + 8) + "px";

        document.getElementById("selected-preview").src = src;

        document.getElementById("applyStickerBtn").onclick = () => {
            addSticker(src);
        };
    });
});

/* ------------------------------
   스티커 추가
------------------------------ */
function addSticker(src) {
    const wrapper = document.createElement("div");
    wrapper.className = "sticker-wrapper";
    wrapper.style.left = "120px";
    wrapper.style.top = "120px";
    wrapper.style.zIndex = 10;

    const st = document.createElement("img");
    st.src = src;
    st.className = "placed-sticker";

    const handle = document.createElement("div");
    handle.className = "resize-handle";

    wrapper.appendChild(st);
    wrapper.appendChild(handle);
    uploadBox.appendChild(wrapper);

    makeDraggable(wrapper);
    makeResizable(wrapper, handle);
}

/* ------------------------------
   스티커 드래그 이벤트
------------------------------ */
function makeDraggable(wrapper) {
    let isDown = false;
    let offsetX = 0, offsetY = 0;

    wrapper.addEventListener("mousedown", e => {
        if (e.target.classList.contains("resize-handle")) return;

        isDown = true;
        offsetX = e.offsetX;
        offsetY = e.offsetY;

        wrapper.style.zIndex = Number(wrapper.style.zIndex || 10) + 1;
    });

    document.addEventListener("mouseup", () => isDown = false);

    document.addEventListener("mousemove", e => {
        if (!isDown) return;

        const rect = uploadBox.getBoundingClientRect();
        wrapper.style.left = (e.pageX - rect.left - offsetX) + "px";
        wrapper.style.top = (e.pageY - rect.top - offsetY) + "px";
    });
}

/* ------------------------------
   크기 조절 이벤트
------------------------------ */
function makeResizable(wrapper, handle) {
    let resizing = false;

    handle.addEventListener("mousedown", e => {
        resizing = true;
        e.stopPropagation();
    });

    document.addEventListener("mouseup", () => resizing = false);

    document.addEventListener("mousemove", e => {
        if (!resizing) return;

        const rect = wrapper.getBoundingClientRect();
        const newWidth = e.pageX - rect.left;

        if (newWidth > 40) {
            wrapper.style.width = newWidth + "px";
        }
    });
}

/* ------------------------------
   이미지 저장
------------------------------ */
document.getElementById("saveBtn").addEventListener("click", () => {
    const canvas = document.createElement("canvas");
    canvas.width = uploadBox.offsetWidth;
    canvas.height = uploadBox.offsetHeight;
    const ctx = canvas.getContext("2d");

    if (bgImage.src) {
        ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
    }

    document.querySelectorAll(".sticker-wrapper").forEach(w => {
        const img = w.querySelector("img");
        const x = parseInt(w.style.left);
        const y = parseInt(w.style.top);
        const wdt = w.offsetWidth;
        const hgt = img.offsetHeight * (wdt / img.naturalWidth);

        ctx.drawImage(img, x, y, wdt, hgt);
    });

    const link = document.createElement("a");
    link.href = canvas.toDataURL("image/png");
    link.download = "final_image.png";
    link.click();
});
</script>

</body>
</html>
